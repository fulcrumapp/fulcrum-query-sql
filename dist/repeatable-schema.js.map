{"version":3,"file":"repeatable-schema.js","names":["SYSTEM_COLUMNS","RepeatableSchema","formSchema","repeatable","rawColumns","fullSchema","container","_columns","_rawColumns","_rawColumnsByKey","_columnsByKey","column","indexOf","name","field","key","part","setupColumns","addSystemColumn","feature","options","recordID","record","id","parentID","parent","form","statusField","isEnabled","addRawElementColumn","_record_status","isProjectEnabled","projectColumn","tableName","alias","sourceColumn","joinColumn","isAssignmentEnabled","assignedToColumn","createdByColumn","updatedByColumn","Object","keys","includes","expr1","AExpr","ColumnRef","expr2","BooleanTest","recordSeriesColumn","ast","BoolExpr","setupElementColumns","dataName","FormFieldSchema"],"sources":["../src/repeatable-schema.js"],"sourcesContent":["import FormFieldSchema from './form-field-schema';\n\nconst SYSTEM_COLUMNS = [\n  '_child_record_id',\n  '_record_id',\n  '_parent_id',\n  '_record_project_id',\n  '_record_assigned_to_id',\n  '_record_status',\n  '_index',\n  '_latitude',\n  '_longitude',\n  '_created_at',\n  '_updated_at',\n  '_version',\n  '_created_by_id',\n  '_updated_by_id',\n  '_server_created_at',\n  '_server_updated_at',\n  '_geometry',\n  '_changeset_id',\n  '_title',\n  '_created_latitude',\n  '_created_longitude',\n  '_created_geometry',\n  '_created_altitude',\n  '_created_horizontal_accuracy',\n  '_updated_latitude',\n  '_updated_longitude',\n  '_updated_geometry',\n  '_updated_altitude',\n  '_updated_horizontal_accuracy',\n  '_created_duration',\n  '_updated_duration',\n  '_edited_duration',\n  '_record_series_id'\n];\n\nexport default class RepeatableSchema extends FormFieldSchema {\n  constructor(formSchema, repeatable, rawColumns, {fullSchema = false}) {\n    super({fullSchema});\n\n    this.formSchema = formSchema;\n    this.repeatable = repeatable;\n    this.container = repeatable;\n\n    this._columns = [];\n    this._rawColumns = rawColumns;\n\n    this._rawColumnsByKey = {};\n    this._columnsByKey = {};\n\n    for (const column of rawColumns) {\n      if (SYSTEM_COLUMNS.indexOf(column.name) !== -1) {\n        this._rawColumnsByKey[column.name] = column;\n      } else if (column.field) {\n        const key = column.part ? column.field + '_' + column.part : column.field;\n        this._rawColumnsByKey[key] = column;\n      }\n    }\n\n    this.setupColumns();\n  }\n\n  setupColumns() {\n    if (this.fullSchema) {\n      this.addSystemColumn('Child Record ID', 'id', '_child_record_id', 'string');\n\n      this.addSystemColumn('Record ID', null, '_record_id', 'string', (feature, options) => {\n        if (feature.recordID) {\n          return feature.recordID;\n        }\n\n        return options && options.record && options.record.id;\n      });\n\n      this.addSystemColumn('Parent ID', null, '_parent_id', 'string', (feature, options) => {\n        if (feature.parentID) {\n          return feature.parentID;\n        }\n\n        return options && options.parent && options.parent.id;\n      });\n    }\n\n    if (this.formSchema.form.statusField.isEnabled) {\n      this.addRawElementColumn(this.formSchema.form.statusField,\n                               this._rawColumnsByKey._record_status,\n                               '_record_status',\n                               'string',\n                               null,\n                               '_record_status');\n    }\n\n    this.addSystemColumn('Title', 'displayValue', '_title', 'string');\n    this.addSystemColumn('Version', 'version', '_version', 'integer');\n    this.addSystemColumn('Device Created', 'createdAt', '_created_at', 'timestamp');\n    this.addSystemColumn('Device Updated', 'updatedAt', '_updated_at', 'timestamp');\n\n    if (this.formSchema.form.isProjectEnabled) {\n      this.projectColumn = this.addSystemColumn('Project',\n                                                'recordProjectName',\n                                                'record_project.name',\n                                                'string',\n                                                null,\n                                                {tableName: 'projects',\n                                                 alias: 'record_project',\n                                                 sourceColumn: '_record_project_id',\n                                                 joinColumn: 'project_id'});\n    }\n\n    if (this.formSchema.form.isAssignmentEnabled) {\n      this.assignedToColumn = this.addSystemColumn('Assigned',\n                                                   'recordAssignedToName',\n                                                   'record_assigned_to.name',\n                                                   'string',\n                                                   null,\n                                                   {tableName: 'memberships',\n                                                    alias: 'record_assigned_to',\n                                                    sourceColumn: '_record_assigned_to_id',\n                                                    joinColumn: 'user_id'});\n    }\n\n    this.createdByColumn = this.addSystemColumn('Created By',\n                                                'createdByName',\n                                                'created_by.name',\n                                                'string',\n                                                null,\n                                                {tableName: 'memberships',\n                                                 alias: 'created_by',\n                                                 sourceColumn: '_created_by_id',\n                                                 joinColumn: 'user_id'});\n\n    this.updatedByColumn = this.addSystemColumn('Updated By',\n                                                'updatedByName',\n                                                'updated_by.name',\n                                                'string',\n                                                null,\n                                                {tableName: 'memberships',\n                                                 alias: 'updated_by',\n                                                 sourceColumn: '_updated_by_id',\n                                                 joinColumn: 'user_id'});\n\n    if (Object.keys(this._rawColumnsByKey).includes('_record_series_id')) {\n      const expr1 = AExpr(0, '=', ColumnRef('_record_series_id', 'records'), ColumnRef('record_series_id', 'record_series'));\n      const expr2 = BooleanTest(ColumnRef('enabled', 'record_series'), 0);\n      this.recordSeriesColumn = this.addSystemColumn('Record Series',\n                                                    'recordSeries',\n                                                    'record_series.rrule',\n                                                    'string',\n                                                    null,\n                                                    {tableName: 'record_series',\n                                                      alias: 'record_series',\n                                                      ast: BoolExpr(0, [ expr1, expr2, ])});\n    };\n\n    if (this.fullSchema) {\n      this.addSystemColumn('Item Index', 'index', '_index', 'integer');\n      this.addSystemColumn('Geometry', 'geometryAsGeoJSON', '_geometry', 'geometry');\n      this.addSystemColumn('Latitude', 'latitude', '_latitude', 'double');\n      this.addSystemColumn('Longitude', 'longitude', '_longitude', 'double');\n\n      this.addSystemColumn('Changeset', 'changesetID', '_changeset_id', 'string');\n\n      this.addSystemColumn('Created Duration', 'createdDuration', '_created_duration', 'integer');\n      this.addSystemColumn('Updated Duration', 'updatedDuration', '_updated_duration', 'integer');\n      this.addSystemColumn('Edited Duration', 'editedDuration', '_edited_duration', 'integer');\n    }\n\n    this.setupElementColumns();\n  }\n\n  get tableName() {\n    return this.formSchema.tableName + '_' + this.repeatable.dataName;\n  }\n\n  get tableNameWithoutPrefix() {\n    return this.repeatable.dataName;\n  }\n}\n"],"mappings":"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"}