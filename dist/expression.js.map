{"version":3,"sources":["../src/expression.js"],"names":["Expression","attrs","schema","_field","field","_operator","operator","_value","value","_schema","toggleValue","containsValue","newValues","selectedValue","JSON","stringify","push","map","indexOf","toJSON","isValid","isEqual","other","availableOperators","column","clearRangeValuesIfNull","labelForValue","separator","element","isStatusElement","choice","statusForValue","label","isChoiceElement","choiceByValue","Array","isArray","join","toString","toHumanDescription","parts","name","columnName","OperatorsByValue","supportsValue","length","hasValue","columnForFieldKey","id","find","o","date","startOf","format","endOf"],"mappings":"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","sourcesContent":["import _ from 'lodash';\n\nimport { availableOperatorsForColumn, isValueRequired, isDateOperator, OperatorsByValue } from './operator';\n\nexport class Expression {\n  constructor(attrs, schema) {\n    attrs = attrs || {};\n\n    this._field = attrs.field || null;\n    this._operator = attrs.operator || null;\n    this._value = attrs.value || null;\n    this._schema = schema;\n  }\n\n  get isValid() {\n    if (!isValueRequired(this.operator)) {\n      return this.column != null && this.operator != null;\n    }\n\n    return this.column != null && this.operator != null && this.hasValue;\n  }\n\n  get supportsValue() {\n    return isValueRequired(this.operator);\n  }\n\n  get hasValue() {\n    return this.value !== null && this.value.length !== 0;\n  }\n\n  get value() {\n    return this._value;\n  }\n\n  get arrayValue() {\n    if (this.hasValue) {\n      return Array.isArray(this.value[0]) ? this.value[0] : this.value;\n    }\n\n    return null;\n  }\n\n  get scalarValue() {\n    if (this.hasValue) {\n      return this.value[0];\n    }\n\n    return null;\n  }\n\n  set scalarValue(value) {\n    this._value = value ? [ value ] : null;\n  }\n\n  get value1() {\n    return this.value && this.value[0];\n  }\n\n  set value1(value) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ value, this.value[1] ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  get value2() {\n    return this.value && this.value[1];\n  }\n\n  set value2(value) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ this.value[0], value ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  get isDateOperator() {\n    return isDateOperator(this.operator);\n  }\n\n  get operator() {\n    return this._operator;\n  }\n\n  set operator(operator) {\n    this._operator = operator;\n  }\n\n  get field() {\n    return this._field;\n  }\n\n  set field(field) {\n    this._field = field;\n  }\n\n  get column() {\n    return this._schema.columnForFieldKey(this.field);\n  }\n\n  set column(column) {\n    this._field = column ? column.id : null;\n\n    // if the change in the field results in the operator not being valid, clear the operator\n    if (this._operator && this.availableOperators().find(o => o.name === this._operator) === -1) {\n      this._operator = null;\n    }\n  }\n\n  get columnName() {\n    if (this.column) {\n      return this.column.columnName;\n    }\n    return null;\n  }\n\n  toggleValue(value) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    if (this.containsValue(value)) {\n      const newValues = [];\n\n      for (const selectedValue of this.value) {\n        if (JSON.stringify(selectedValue) !== JSON.stringify(value)) {\n          newValues.push(selectedValue);\n        }\n      }\n\n      this._value = newValues;\n    } else {\n      this._value.push(value);\n    }\n  }\n\n  containsValue(value) {\n    if (this.value == null) {\n      return false;\n    }\n\n    return this.value.map(JSON.stringify).indexOf(JSON.stringify(value)) > -1;\n  }\n\n  toJSON() {\n    if (!this.isValid) {\n      return null;\n    }\n\n    return {\n      field: this._field,\n      operator: this._operator,\n      value: this._value\n    };\n  }\n\n  isEqual(other) {\n    if (other == null || !(other instanceof Expression)) {\n      return false;\n    }\n\n    return this.field === other.field &&\n           this.operator === other.operator &&\n           JSON.stringify(this.value) === JSON.stringify(other.value);\n  }\n\n  availableOperators() {\n    return availableOperatorsForColumn(this.column);\n  }\n\n  get startDate() {\n    return this._value && this._value[0];\n  }\n\n  set startDate(date) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ date && date.startOf('day').format('YYYY-MM-DD HH:mm:ss'), this.value[1] ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  get endDate() {\n    return this._value && this._value[1];\n  }\n\n  set endDate(date) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ this.value[0], date && date.endOf('day').format('YYYY-MM-DD HH:mm:ss') ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  clearRangeValuesIfNull() {\n    // if both values are null, clear it, don't allow [ null, null ]\n    if (this._value[0] == null && this._value[1] == null) {\n      this._value = null;\n    }\n  }\n\n  labelForValue(value, {separator} = {}) {\n    const column = this.column;\n\n    if (!column) {\n      return value;\n    }\n\n    const element = this.column.element;\n\n    if (element) {\n      if (element.isStatusElement) {\n        const choice = element.statusForValue(value);\n\n        if (choice) {\n          return choice.label;\n        }\n      } else if (element.isChoiceElement) {\n        const choice = element.choiceByValue(value);\n\n        if (choice) {\n          return choice.label;\n        }\n      }\n    }\n\n    return Array.isArray(value) ? value.join(separator != null ? separator : ', ')\n                                : value && value.toString();\n  }\n\n  toHumanDescription() {\n    if (!this.isValid) {\n      return null;\n    }\n\n    const parts = [\n      this.column ? this.column.name : this.columnName,\n      OperatorsByValue[this.operator].label\n    ];\n\n    if (this.supportsValue) {\n      if (this.value.length === 1) {\n        parts.push(this.value.join(', '));\n      } else {\n        parts.push('[' + this.value.join(', ') + ']');\n      }\n    }\n\n    return parts.join(' ');\n  }\n}\n"],"file":"expression.js"}