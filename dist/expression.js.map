{"version":3,"file":"expression.js","names":["Expression","attrs","schema","_field","field","_operator","operator","_value","value","_schema","toggleValue","containsValue","newValues","selectedValue","JSON","stringify","push","map","indexOf","toJSON","isValid","isEqual","other","availableOperators","availableOperatorsForColumn","column","clearRangeValuesIfNull","labelForValue","separator","element","isStatusElement","choice","statusForValue","label","isChoiceElement","choiceByValue","Array","isArray","join","toString","toHumanDescription","parts","name","columnName","OperatorsByValue","supportsValue","length","isValueRequired","hasValue","isDateOperator","columnForFieldKey","id","find","o","date","startOf","format","endOf"],"sources":["../src/expression.js"],"sourcesContent":["import _ from 'lodash';\n\nimport { availableOperatorsForColumn, isValueRequired, isDateOperator, OperatorsByValue } from './operator';\n\nexport class Expression {\n  constructor(attrs, schema) {\n    attrs = attrs || {};\n\n    this._field = attrs.field || null;\n    this._operator = attrs.operator || null;\n    this._value = attrs.value || null;\n    this._schema = schema;\n  }\n\n  get isValid() {\n    if (!isValueRequired(this.operator)) {\n      return this.column != null && this.operator != null;\n    }\n\n    return this.column != null && this.operator != null && this.hasValue;\n  }\n\n  get supportsValue() {\n    return isValueRequired(this.operator);\n  }\n\n  get hasValue() {\n    return this.value !== null && this.value.length !== 0;\n  }\n\n  get value() {\n    return this._value;\n  }\n\n  get arrayValue() {\n    if (this.hasValue) {\n      return Array.isArray(this.value[0]) ? this.value[0] : this.value;\n    }\n\n    return null;\n  }\n\n  get scalarValue() {\n    if (this.hasValue) {\n      return this.value[0];\n    }\n\n    return null;\n  }\n\n  set scalarValue(value) {\n    this._value = value ? [ value ] : null;\n  }\n\n  get value1() {\n    return this.value && this.value[0];\n  }\n\n  set value1(value) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ value, this.value[1] ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  get value2() {\n    return this.value && this.value[1];\n  }\n\n  set value2(value) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ this.value[0], value ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  get isDateOperator() {\n    return isDateOperator(this.operator);\n  }\n\n  get operator() {\n    return this._operator;\n  }\n\n  set operator(operator) {\n    this._operator = operator;\n  }\n\n  get field() {\n    return this._field;\n  }\n\n  set field(field) {\n    this._field = field;\n  }\n\n  get column() {\n    return this._schema.columnForFieldKey(this.field);\n  }\n\n  set column(column) {\n    this._field = column ? column.id : null;\n\n    // if the change in the field results in the operator not being valid, clear the operator\n    if (this._operator && this.availableOperators().find(o => o.name === this._operator) === -1) {\n      this._operator = null;\n    }\n  }\n\n  get columnName() {\n    if (this.column) {\n      return this.column.columnName;\n    }\n    return null;\n  }\n\n  toggleValue(value) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    if (this.containsValue(value)) {\n      const newValues = [];\n\n      for (const selectedValue of this.value) {\n        if (JSON.stringify(selectedValue) !== JSON.stringify(value)) {\n          newValues.push(selectedValue);\n        }\n      }\n\n      this._value = newValues;\n    } else {\n      this._value.push(value);\n    }\n  }\n\n  containsValue(value) {\n    if (this.value == null) {\n      return false;\n    }\n\n    return this.value.map(JSON.stringify).indexOf(JSON.stringify(value)) > -1;\n  }\n\n  toJSON() {\n    if (!this.isValid) {\n      return null;\n    }\n\n    return {\n      field: this._field,\n      operator: this._operator,\n      value: this._value\n    };\n  }\n\n  isEqual(other) {\n    if (other == null || !(other instanceof Expression)) {\n      return false;\n    }\n\n    return this.field === other.field &&\n           this.operator === other.operator &&\n           JSON.stringify(this.value) === JSON.stringify(other.value);\n  }\n\n  availableOperators() {\n    return availableOperatorsForColumn(this.column);\n  }\n\n  get startDate() {\n    return this._value && this._value[0];\n  }\n\n  set startDate(date) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ date && date.startOf('day').format('YYYY-MM-DD HH:mm:ss'), this.value[1] ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  get endDate() {\n    return this._value && this._value[1];\n  }\n\n  set endDate(date) {\n    if (!this._value) {\n      this._value = [];\n    }\n\n    this._value = [ this.value[0], date && date.endOf('day').format('YYYY-MM-DD HH:mm:ss') ];\n\n    this.clearRangeValuesIfNull();\n  }\n\n  clearRangeValuesIfNull() {\n    // if both values are null, clear it, don't allow [ null, null ]\n    if (this._value[0] == null && this._value[1] == null) {\n      this._value = null;\n    }\n  }\n\n  labelForValue(value, {separator} = {}) {\n    const column = this.column;\n\n    if (!column) {\n      return value;\n    }\n\n    const element = this.column.element;\n\n    if (element) {\n      if (element.isStatusElement) {\n        const choice = element.statusForValue(value);\n\n        if (choice) {\n          return choice.label;\n        }\n      } else if (element.isChoiceElement) {\n        const choice = element.choiceByValue(value);\n\n        if (choice) {\n          return choice.label;\n        }\n      }\n    }\n\n    return Array.isArray(value) ? value.join(separator != null ? separator : ', ')\n                                : value && value.toString();\n  }\n\n  toHumanDescription() {\n    if (!this.isValid) {\n      return null;\n    }\n\n    const parts = [\n      this.column ? this.column.name : this.columnName,\n      OperatorsByValue[this.operator].label\n    ];\n\n    if (this.supportsValue) {\n      if (this.value.length === 1) {\n        parts.push(this.value.join(', '));\n      } else {\n        parts.push('[' + this.value.join(', ') + ']');\n      }\n    }\n\n    return parts.join(' ');\n  }\n}\n"],"mappings":"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"}